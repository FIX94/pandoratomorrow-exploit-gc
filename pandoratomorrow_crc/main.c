// Copyright 2018 FIX94
// This code is licensed to you under the terms of the GNU GPL, version 2;
// see file LICENSE or http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt

#include <stdio.h>
#include <malloc.h>
#include "crc32.h"

int main(int argc, char *argv[])
{
	if(argc != 2) return 0;
	FILE *f = fopen(argv[1],"rb");
	fseek(f,0,SEEK_END);
	size_t fsize = ftell(f);
	if(fsize != 0xA040)
	{
		puts("No pandora tomorrow gci!");
		fclose(f);
		return 0;
	}
	rewind(f);
	unsigned char *buf = malloc(fsize);
	fread(buf,fsize,1,f);
	fclose(f);

	unsigned int crc = crc32simple(buf+0x40,0x9FFC);
	crc = __builtin_bswap32(crc);
	memcpy(buf+0xA03C, &crc, 4);

	f = fopen(argv[1],"wb");
	fwrite(buf,0xA040,1,f);
	fclose(f);
	free(buf);
	return 0;
}